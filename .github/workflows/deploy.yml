name: CD Pipeline - Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and Push Docker Images
        run: |
          services=("user-service" "product-service" "order-service" "analytics-service" "api-gateway" "frontend")
          for service in "${services[@]}"; do
            echo "Building $service..."
            docker build -t ${{ secrets.DOCKER_USERNAME }}/$service:latest ./services/$service || docker build -t ${{ secrets.DOCKER_USERNAME }}/$service:latest ./frontend
            docker push ${{ secrets.DOCKER_USERNAME }}/$service:latest
          done
      
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/ecommerce-analytics-platform
            
            # Pull latest code
            git pull origin main
            
            # Pull latest Docker images
            docker-compose pull
            
            # Stop and remove old containers
            docker-compose down
            
            # Start new containers
            docker-compose up -d
            
            # Clean up unused images
            docker image prune -af
            
            # Wait for services to be healthy
            echo "Waiting for services to start..."
            sleep 30
            
            # Check service health
            services=("user-service" "product-service" "order-service" "analytics-service" "api-gateway")
            for service in "${services[@]}"; do
              status=$(docker-compose ps $service --format json | jq -r '.Health')
              echo "$service status: $status"
            done
      
      - name: Run Smoke Tests
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Test API Gateway
            curl -f http://localhost:8000/health || exit 1
            
            # Test User Service
            curl -f http://localhost:8001/health || exit 1
            
            # Test Product Service
            curl -f http://localhost:8002/health || exit 1
            
            # Test Order Service
            curl -f http://localhost:8003/health || exit 1
            
            # Test Analytics Service
            curl -f http://localhost:8004/health || exit 1
            
            echo "All smoke tests passed!"
      
      - name: Notify on Success
        if: success()
        run: |
          echo "Deployment successful!"
          # Add Slack/Discord/Email notification here if needed
      
      - name: Notify on Failure
        if: failure()
        run: |
          echo "Deployment failed!"
          # Add Slack/Discord/Email notification here if needed
